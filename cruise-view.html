<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í¬ë£¨ì¦ˆ ìƒì„¸ - í¬ë£¨ì¦ˆë§í¬</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš¢</text></svg>">
</head>
<body>
  <div id="header"></div>
  <div id="content">
    <div class="loading" style="padding:100px 20px"><div class="loading-spinner"></div><p>í¬ë£¨ì¦ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
  </div>
  <div id="ctaSection"></div>
  <div id="footer"></div>

  <script src="assets/data/translations.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/components.js"></script>
  <script>
    document.getElementById('header').innerHTML = Components.header();
    document.getElementById('footer').innerHTML = Components.footer();
    document.getElementById('ctaSection').innerHTML = Components.ctaSection();

    const ref = new URLSearchParams(location.search).get('ref');
    if (!ref) { document.getElementById('content').innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</p></div>'; }

    async function load() {
      if (!ref) return;
      const content = document.getElementById('content');

      try {
        const h = await API.getHoliday(ref);
        if (!h) { content.innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>í¬ë£¨ì¦ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>'; return; }

        // Get ship data
        const ships = await API.getAllShips();
        const ship = ships.find(s => s.title === h.ship_title);
        const shipSlug = ship?.href?.match(/ships\/([^.]+)\.json/)?.[1];
        let shipData = null;
        if (shipSlug) shipData = await API.getShip(shipSlug);

        const price = h.headline_prices?.cruise?.double;
        const fromPrice = price?.from_balcony || price?.from_inside;
        const tags = API.hashtags(h);
        const route = API.routeString(h.itinerary);

        document.title = `${Translations.portName(h.starts_at?.name||'')} ì¶œë°œ ${h.cruise_nights||h.duration_days||''}ë°• í¬ë£¨ì¦ˆ - í¬ë£¨ì¦ˆë§í¬`;

        let html = '';

        // HERO
        html += `
        <section class="detail-hero">
          <div class="container">
            <div class="operator-name">${h.operator_title || ''} Â· ${h.ship_title || ''}</div>
            <h1>${Translations.portName(h.starts_at?.name||'')} ì¶œë°œ ${h.cruise_nights||h.duration_days||''}ë°• í¬ë£¨ì¦ˆ</h1>
            <div class="meta">
              <span>ğŸ“… ${API.formatDateKo(h.date_from)} ~ ${API.formatDateKo(h.date_to)}</span>
              <span>ğŸŒ™ ${h.cruise_nights||h.duration_days||''}ë°• ${h.duration_days||''}ì¼</span>
              <span>ğŸš¢ ${h.ship_title||''}</span>
              <span>ğŸŒ ${h.countries?.map(c => Translations.countryName(c)).join(', ') || ''}</span>
            </div>
            <div class="hashtags">${tags.map(t => `<span>${t}</span>`).join('')}</div>
            <div class="price-big">${API.formatPrice(fromPrice)} <small>/1ì¸ 2ì¸ê¸°ì¤€</small></div>
            <div class="hero-ctas">
              <a href="https://pf.kakao.com/_xgYbJG" target="_blank" class="btn btn-orange">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ìƒë‹´</a>
              <a href="tel:02-3788-9119" class="btn btn-white">ğŸ“ ì „í™” ìƒë‹´</a>
              <a href="mailto:info@londonshow.co.kr" class="btn btn-outline">âœ‰ï¸ ì´ë©”ì¼ ë¬¸ì˜</a>
            </div>
          </div>
        </section>`;

        // Main ship image
        if (ship?.cover_image_href) {
          html += `<div class="container"><div class="main-ship-image"><img src="${ship.cover_image_href}" alt="${h.ship_title}" loading="lazy"></div></div>`;
        }

        // Info bar
        html += `
        <div class="container">
          <div class="info-bar">
            <div class="info-bar-item"><div class="label">ì„ ë°•</div><div class="value">${h.ship_title||''}</div></div>
            <div class="info-bar-item"><div class="label">ê¸°ê°„</div><div class="value">${h.cruise_nights||h.duration_days||''}ë°• ${h.duration_days||''}ì¼</div></div>
            <div class="info-bar-item"><div class="label">ì¶œë°œ/ë„ì°©</div><div class="value">${Translations.portName(h.starts_at?.name||'')} â†’ ${Translations.portName(h.ends_at?.name||'')}</div></div>
            <div class="info-bar-item"><div class="label">ê°€ê²©(2ì¸ê¸°ì¤€)</div><div class="value" style="color:var(--orange)">${API.formatPrice(fromPrice)}</div></div>
          </div>
        </div>`;

        // ITINERARY
        if (h.itinerary?.days?.length) {
          html += `<section class="section"><div class="container">
            <h2 class="section-title">ìƒì„¸ ì¼ì •</h2>
            <p class="section-subtitle">${route}</p>
            <div class="day-cards">`;

          for (const day of h.itinerary.days) {
            const loc = day.locations?.[0];
            const isSeaDay = !loc || day.day_type?.includes('SEA') || day.day_name?.toLowerCase().includes('at sea');
            const portName = loc ? Translations.portName(loc.name) : 'ì¢…ì¼ í•­í•´';
            const countryName = loc ? Translations.countryName(loc.country) : '';
            const arrTime = loc?.arrival_time || '';
            const depTime = loc?.departure_time || '';
            const timeStr = arrTime && depTime ? `${arrTime} - ${depTime}` : arrTime || depTime || '';
            const portImages = loc?.widgety_data?.images || [];
            const portDesc = loc ? (Translations.portDesc(loc.name) || '') : '';

            if (isSeaDay) {
              html += `
              <div class="day-card sea-day">
                <div class="day-card-header">
                  <span class="day-num">DAY ${day.day}</span>
                  <span class="day-port">ğŸŒŠ ì¢…ì¼ í•­í•´</span>
                  <span class="day-time"></span>
                </div>
                <div class="day-card-body">
                  <p>ì˜¤ëŠ˜ì€ ì¢…ì¼ í•­í•´ì¼ì…ë‹ˆë‹¤. ì„ ë°•ì˜ ë‹¤ì–‘í•œ ì‹œì„¤ê³¼ ì—”í„°í…Œì¸ë¨¼íŠ¸ë¥¼ ì¦ê¸°ì„¸ìš”. ìˆ˜ì˜ì¥, ìŠ¤íŒŒ, ì¹´ì§€ë…¸, ë ˆìŠ¤í† ë‘ ë“± ë‹¤ì±„ë¡œìš´ ì„ ìƒ í™œë™ì´ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>
              </div>`;
            } else {
              html += `
              <div class="day-card">
                <div class="day-card-header">
                  <span class="day-num">DAY ${day.day}</span>
                  <span class="day-port">${portName}${countryName ? ', ' + countryName : ''}</span>
                  <span class="day-time">${timeStr ? 'â° ' + timeStr : ''}</span>
                </div>
                <div class="day-card-body">
                  ${portImages[0] ? `<img src="${portImages[0].href}" alt="${portName}" class="port-img" loading="lazy">` : ''}
                  ${portDesc ? `<p class="port-desc">${portDesc}</p>` : ''}
                  ${portImages.length > 1 ? `<div class="day-card-images">${portImages.slice(1, 4).map(img => `<img src="${img.href}" alt="${img.name||portName}" loading="lazy">`).join('')}</div>` : ''}
                </div>
              </div>`;
            }
          }
          html += `</div></div></section>`;
        }

        // SHIP INFO
        if (shipData || ship) {
          const s = shipData || ship;
          const facts = s.ship_facts || {};
          html += `<section class="section" style="background:var(--gray-50)"><div class="container">
            <h2 class="section-title">ì„ ë°• ì†Œê°œ - ${h.ship_title}</h2>
            <div class="spec-grid">`;
          const specs = [
            ['ì·¨í•­ì—°ë„', facts.launch_year || '-'],
            ['ì´í†¤ìˆ˜', facts.gross_tonnage ? facts.gross_tonnage.toLocaleString() + 't' : '-'],
            ['ìµœëŒ€ì •ì›', facts.capacity ? facts.capacity.toLocaleString() + 'ëª…' : '-'],
            ['ìŠ¹ë¬´ì›', facts.crew_count ? facts.crew_count.toLocaleString() + 'ëª…' : '-'],
            ['ì „ì¥', facts.length ? facts.length + 'm' : '-'],
            ['ì „í­', facts.width ? facts.width + 'm' : '-'],
            ['ë°í¬', facts.deck_count ? facts.deck_count + 'ê°œ' : '-'],
            ['ê°ì‹¤', facts.cabin_count ? facts.cabin_count.toLocaleString() + 'ì‹¤' : '-'],
          ];
          specs.forEach(([label, value]) => {
            html += `<div class="spec-item"><div class="spec-label">${label}</div><div class="spec-value">${value}</div></div>`;
          });
          html += `</div>`;

          // Tabs
          const tabData = [];
          if (s.dining?.intro) tabData.push({ id: 'dining', label: 'ğŸ½ï¸ ë‹¤ì´ë‹', content: s.dining.intro });
          if (s.entertainment?.intro) tabData.push({ id: 'entertainment', label: 'ğŸ­ ì—”í„°í…Œì¸ë¨¼íŠ¸', content: s.entertainment.intro });
          if (s.health_and_fitness?.intro) tabData.push({ id: 'spa', label: 'ğŸ’† ìŠ¤íŒŒ', content: s.health_and_fitness.intro });
          if (s.kids_and_teens?.intro) tabData.push({ id: 'kids', label: 'ğŸ‘¶ í‚¤ì¦ˆ', content: s.kids_and_teens.intro });

          if (tabData.length) {
            html += `<div class="tabs">${tabData.map((t, i) => `<button class="tab-btn ${i === 0 ? 'active' : ''}" onclick="switchTab('${t.id}')">${t.label}</button>`).join('')}</div>`;
            tabData.forEach((t, i) => {
              html += `<div class="tab-content ${i === 0 ? 'active' : ''}" id="tab-${t.id}">${t.content}</div>`;
            });
          }
          html += `</div></section>`;
        }

        // PRICING
        if (price) {
          html += `<section class="section"><div class="container">
            <h2 class="section-title">ê°ì‹¤ & ìš”ê¸ˆ</h2>
            <p class="section-subtitle">1ì¸ ê¸°ì¤€ ìš”ê¸ˆ (ì„¸ê¸ˆ/í•­ë§Œë£Œ ë³„ë„)</p>
            <table class="price-table">
              <thead><tr><th>ê°ì‹¤ íƒ€ì…</th><th>2ì¸ 1ì‹¤</th><th>1ì¸ 1ì‹¤</th><th>3ì¸ 1ì‹¤</th></tr></thead>
              <tbody>`;
          const types = [
            { key: 'inside', label: 'ë‚´ì¸¡ (Inside)' },
            { key: 'outside', label: 'ì˜¤ì…˜ë·° (Outside)' },
            { key: 'balcony', label: 'ë°œì½”ë‹ˆ (Balcony)' },
            { key: 'suite', label: 'ìŠ¤ìœ„íŠ¸ (Suite)' },
          ];
          const single = h.headline_prices?.cruise?.single;
          const triple = h.headline_prices?.cruise?.triple;
          types.forEach(t => {
            const dp = price?.['from_' + t.key];
            const sp = single?.['from_' + t.key];
            const tp = triple?.['from_' + t.key];
            if (dp || sp || tp) {
              html += `<tr><td class="room-type">${t.label}</td><td>${API.formatPrice(dp)}</td><td>${API.formatPrice(sp)}</td><td>${API.formatPrice(tp)}</td></tr>`;
            }
          });
          html += `</tbody></table>`;

          // Cabin photos from ship data
          if (shipData?.accomodation_types?.length) {
            html += `<h3 style="margin-top:32px;color:var(--navy);font-weight:700">ê°ì‹¤ íƒ€ì…</h3><div class="cabin-grid" style="margin-top:16px">`;
            shipData.accomodation_types.slice(0, 8).forEach(at => {
              const imgs = at.images || [];
              const img = imgs[0]?.href || '';
              html += `<div class="cabin-card">${img ? `<img src="${img}" alt="${at.name}" loading="lazy">` : ''}<div class="cabin-card-body"><h4>${at.name}</h4></div></div>`;
            });
            html += `</div>`;
          }
          html += `</div></section>`;
        }

        // INCLUDED / EXCLUDED
        html += `<section class="section" style="background:var(--gray-50)"><div class="container">
          <h2 class="section-title">í¬í•¨ / ë¶ˆí¬í•¨ ì‚¬í•­</h2>
          <div class="checklist-grid">
            <div>
              <h3 style="color:var(--navy);margin-bottom:16px">âœ… í¬í•¨ ì‚¬í•­</h3>
              <ul class="checklist included">
                <li>ê°ì‹¤ ìˆ™ë°•</li>
                <li>ë©”ì¸ ë ˆìŠ¤í† ë‘ & ë·”í˜ ì‹ì‚¬</li>
                <li>ì„ ìƒ ì—”í„°í…Œì¸ë¨¼íŠ¸ (ì‡¼, ê³µì—°)</li>
                <li>ìˆ˜ì˜ì¥ & í”¼íŠ¸ë‹ˆìŠ¤ ì„¼í„°</li>
                <li>í‚¤ì¦ˆ í´ëŸ½ í”„ë¡œê·¸ë¨</li>
                <li>ê°ì‹¤ ë£¸ì„œë¹„ìŠ¤ (ê¸°ë³¸)</li>
              </ul>
            </div>
            <div>
              <h3 style="color:var(--navy);margin-bottom:16px">âŒ ë¶ˆí¬í•¨ ì‚¬í•­</h3>
              <ul class="checklist excluded">
                <li>í•­ê³µí¸</li>
                <li>ìŠ¤í˜ì…œí‹° ë ˆìŠ¤í† ë‘</li>
                <li>ì£¼ë¥˜ ë° ìŒë£Œ íŒ¨í‚¤ì§€</li>
                <li>ê¸°í•­ì§€ ê´€ê´‘ (Shore Excursion)</li>
                <li>ìŠ¤íŒŒ & ë·°í‹° íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸</li>
                <li>Wi-Fi ì¸í„°ë„·</li>
                <li>ì„¸íƒ ì„œë¹„ìŠ¤</li>
                <li>ì—¬í–‰ì ë³´í—˜</li>
              </ul>
            </div>
          </div>
        </div></section>`;

        content.innerHTML = html;
      } catch (e) {
        console.error(e);
        content.innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
      }
    }

    function switchTab(id) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + id)?.classList.add('active');
    }

    load();
  </script>
</body>
</html>
