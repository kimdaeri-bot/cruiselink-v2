<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„ ë°• ìƒì„¸ - í¬ë£¨ì¦ˆë§í¬</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš¢</text></svg>">
</head>
<body>
  <div id="header"></div>
  <div id="content">
    <div class="loading" style="padding:100px 20px"><div class="loading-spinner"></div><p>ì„ ë°• ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
  </div>
  <div id="ctaSection"></div>
  <div id="footer"></div>

  <script src="assets/data/translations.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/components.js"></script>
  <script>
    document.getElementById('header').innerHTML = Components.header('ships');
    document.getElementById('footer').innerHTML = Components.footer();
    document.getElementById('ctaSection').innerHTML = Components.ctaSection();

    const slug = new URLSearchParams(location.search).get('slug');
    if (!slug) { document.getElementById('content').innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</p></div>'; }

    async function load() {
      if (!slug) return;
      const content = document.getElementById('content');
      try {
        const s = await API.getShip(slug);
        const ships = await API.getAllShips();
        const shipList = ships.find(sh => sh.href?.includes(slug));
        if (!s) { content.innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>ì„ ë°•ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>'; return; }

        const facts = s.ship_facts || {};
        document.title = `${s.title} - í¬ë£¨ì¦ˆë§í¬`;
        let html = '';

        // Hero
        html += `<div class="ship-hero">
          <img src="${shipList?.cover_image_href || s.cover_image_href || ''}" alt="${s.title}">
          <div class="ship-hero-overlay">
            <p>${s.operator?.name || ''} Â· ${s.ship_class || ''}</p>
            <h1>${s.title}</h1>
          </div>
        </div>`;

        // Specs
        html += `<section class="section"><div class="container">
          <div class="spec-grid">`;
        const specs = [
          ['ì·¨í•­ì—°ë„', facts.launch_year || '-'], ['ë¦¬ë‰´ì–¼', facts.refit_year || '-'],
          ['ì´í†¤ìˆ˜', facts.gross_tonnage ? facts.gross_tonnage.toLocaleString() + 't' : '-'],
          ['ì „ì¥', facts.length ? facts.length + 'm' : '-'],
          ['ìµœëŒ€ì •ì›', facts.capacity ? facts.capacity.toLocaleString() + 'ëª…' : '-'],
          ['ìŠ¹ë¬´ì›', facts.crew_count ? facts.crew_count.toLocaleString() + 'ëª…' : '-'],
          ['ë°í¬', facts.deck_count ? facts.deck_count + 'ê°œ' : '-'],
          ['ê°ì‹¤', facts.cabin_count ? facts.cabin_count.toLocaleString() + 'ì‹¤' : '-'],
        ];
        specs.forEach(([l, v]) => html += `<div class="spec-item"><div class="spec-label">${l}</div><div class="spec-value">${v}</div></div>`);
        html += `</div>`;

        // Tabs
        const tabData = [{ id: 'overview', label: 'ğŸ“‹ ê°œìš”', content: s.teaser || s.introduction || '' }];
        if (s.accomodation_types?.length) tabData.push({ id: 'cabin', label: 'ğŸ›ï¸ ê°ì‹¤', content: '__cabins__' });
        if (s.dining?.intro) tabData.push({ id: 'dining', label: 'ğŸ½ï¸ ë‹¤ì´ë‹', content: s.dining.intro });
        if (s.entertainment?.intro) tabData.push({ id: 'entertainment', label: 'ğŸ­ ì—”í„°í…Œì¸ë¨¼íŠ¸', content: s.entertainment.intro });
        if (s.health_and_fitness?.intro) tabData.push({ id: 'spa', label: 'ğŸ’† ìŠ¤íŒŒ', content: s.health_and_fitness.intro });
        if (s.kids_and_teens?.intro) tabData.push({ id: 'kids', label: 'ğŸ‘¶ í‚¤ì¦ˆ', content: s.kids_and_teens.intro });

        html += `<div class="tabs">${tabData.map((t, i) => `<button class="tab-btn ${i === 0 ? 'active' : ''}" onclick="switchTab('${t.id}',this)">${t.label}</button>`).join('')}</div>`;
        tabData.forEach((t, i) => {
          let c = t.content;
          if (c === '__cabins__') {
            c = '<div class="cabin-grid">' + s.accomodation_types.map(at => {
              const img = at.images?.[0]?.href || '';
              return `<div class="cabin-card">${img ? `<img src="${img}" alt="${at.name}" loading="lazy">` : ''}<div class="cabin-card-body"><h4>${at.name}</h4></div></div>`;
            }).join('') + '</div>';
          }
          html += `<div class="tab-content ${i === 0 ? 'active' : ''}" id="tab-${t.id}">${c}</div>`;
        });
        html += `</div></section>`;

        // Video
        if (s.video_url) {
          const vid = s.video_url.match(/(?:v=|\/)([\w-]{11})/)?.[1];
          if (vid) {
            html += `<section class="section" style="background:var(--gray-50)"><div class="container">
              <h2 class="section-title">ì„ ë°• ì˜ìƒ</h2>
              <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;margin-top:24px">
                <iframe src="https://www.youtube.com/embed/${vid}" style="position:absolute;top:0;left:0;width:100%;height:100%" frameborder="0" allowfullscreen loading="lazy"></iframe>
              </div>
            </div></section>`;
          }
        }

        // Cruises for this ship
        if (s.cruises?.length) {
          html += `<section class="section"><div class="container">
            <h2 class="section-title">${s.title} í¬ë£¨ì¦ˆ ì¼ì •</h2>
            <p class="section-subtitle">ì¶œë°œì¼ ê¸°ì¤€ ì •ë ¬ (3ê°œì›” ì´í›„ ì¶œë°œ)</p>
            <div id="shipCruises" class="cruise-list"><div class="loading"><div class="loading-spinner"></div><p>í¬ë£¨ì¦ˆ ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div></div>
          </div></section>`;
        }

        content.innerHTML = html;

        // Load cruises
        if (s.cruises?.length) {
          loadShipCruises(s.cruises, shipList);
        }
      } catch (e) {
        console.error(e);
        content.innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
      }
    }

    async function loadShipCruises(cruises, shipInfo) {
      const container = document.getElementById('shipCruises');
      const threeMonths = new Date(Date.now() + 90 * 86400000);
      const results = [];

      for (const c of cruises.slice(0, 50)) {
        if (results.length >= 20) break;
        try {
          const h = await API.getHoliday(c.ref);
          if (!h?.date_from) continue;
          if (new Date(h.date_from) < threeMonths) continue;
          results.push({ holiday: h, shipInfo: { coverImage: shipInfo?.cover_image_href, operator: shipInfo?.operator?.name } });
        } catch (e) { continue; }
      }

      results.sort((a, b) => new Date(a.holiday.date_from) - new Date(b.holiday.date_from));
      container.innerHTML = results.length
        ? results.map(r => Components.cruiseItem(r.holiday, r.shipInfo)).join('')
        : '<div class="empty-state"><span class="emoji">ğŸ“…</span><p>ì˜ˆì •ëœ í¬ë£¨ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }

    function switchTab(id, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + id)?.classList.add('active');
    }

    load();
  </script>
</body>
</html>
