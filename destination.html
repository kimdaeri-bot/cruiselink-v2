<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í¬ë£¨ì¦ˆë§í¬ - ëª©ì ì§€ë³„ í¬ë£¨ì¦ˆ</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš¢</text></svg>">
</head>
<body>
  <div id="header"></div>

  <section class="hero" style="padding: 48px 0 72px;">
    <div class="container">
      <h1 id="destTitle">í¬ë£¨ì¦ˆ ê²€ìƒ‰</h1>
      <p id="destSubtitle">ëª©ì ì§€ë³„ í¬ë£¨ì¦ˆë¥¼ ì°¾ì•„ë³´ì„¸ìš”</p>
    </div>
  </section>

  <div class="container">
    <div class="filter-bar">
      <div class="filter-group">
        <label>ëª©ì ì§€</label>
        <select id="filterDest">
          <option value="">ì „ì²´</option>
          <option value="korea">í•œêµ­/ì¼ë³¸</option>
          <option value="mediterranean">ì§€ì¤‘í•´</option>
          <option value="alaska">ì•Œë˜ìŠ¤ì¹´</option>
          <option value="caribbean">ì¹´ë¦¬ë¸Œí•´</option>
          <option value="northern-europe">ë¶ìœ ëŸ½</option>
          <option value="southeast-asia">ë™ë‚¨ì•„ì‹œì•„</option>
          <option value="japan">ì¼ë³¸</option>
          <option value="hawaii">í•˜ì™€ì´</option>
        </select>
      </div>
      <div class="filter-group">
        <label>ì„ ì‚¬</label>
        <select id="filterOperator">
          <option value="">ì „ì²´</option>
          <option value="MSC">MSC Cruises</option>
          <option value="Norwegian">Norwegian Cruise Line</option>
        </select>
      </div>
      <div class="filter-group">
        <label>ì¶œë°œì›”</label>
        <select id="filterMonth"><option value="">ì „ì²´</option></select>
      </div>
      <div class="filter-group">
        <label>ê¸°ê°„</label>
        <select id="filterDuration">
          <option value="">ì „ì²´</option>
          <option value="short">1~5ë°•</option>
          <option value="medium">6~10ë°•</option>
          <option value="long">11ë°• ì´ìƒ</option>
        </select>
      </div>
      <button class="btn btn-orange" onclick="applyFilters()">ğŸ” ê²€ìƒ‰</button>
    </div>
  </div>

  <section class="section">
    <div class="container">
      <p class="section-subtitle" id="resultCount"></p>
      <div id="cruiseList" class="cruise-list">
        <div class="loading"><div class="loading-spinner"></div><p>í¬ë£¨ì¦ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
      </div>
      <div id="pagination" class="pagination"></div>
    </div>
  </section>

  <div id="ctaSection"></div>
  <div id="footer"></div>

  <script src="assets/data/translations.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/components.js"></script>
  <script>
    document.getElementById('header').innerHTML = Components.header('dest');
    document.getElementById('footer').innerHTML = Components.footer();
    document.getElementById('ctaSection').innerHTML = Components.ctaSection();

    const params = new URLSearchParams(location.search);
    const dest = params.get('dest') || '';
    const PER_PAGE = 10;
    let currentPage = 1;
    let allResults = [];

    // Set initial filter values from URL
    if (dest) document.getElementById('filterDest').value = dest;
    if (params.get('operator')) document.getElementById('filterOperator').value = params.get('operator');
    if (params.get('duration')) document.getElementById('filterDuration').value = params.get('duration');

    // Update title
    if (dest && Translations.destNameKo[dest]) {
      document.getElementById('destTitle').textContent = Translations.destNameKo[dest] + ' í¬ë£¨ì¦ˆ';
      document.getElementById('destSubtitle').textContent = `${Translations.destNameKo[dest]} ì§€ì—­ì˜ í¬ë£¨ì¦ˆ ìƒí’ˆì„ í™•ì¸í•˜ì„¸ìš”`;
      document.title = `${Translations.destNameKo[dest]} í¬ë£¨ì¦ˆ - í¬ë£¨ì¦ˆë§í¬`;
    }

    // Populate months
    const monthSelect = document.getElementById('filterMonth');
    const now = new Date();
    for (let i = 0; i < 24; i++) {
      const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
      const val = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      monthSelect.innerHTML += `<option value="${val}">${d.getFullYear()}ë…„ ${d.getMonth() + 1}ì›”</option>`;
    }
    if (params.get('month')) monthSelect.value = params.get('month');

    async function loadCruises() {
      const container = document.getElementById('cruiseList');
      const opFilter = document.getElementById('filterOperator').value;
      const monthFilter = document.getElementById('filterMonth').value;
      const durFilter = document.getElementById('filterDuration').value;
      const destFilter = document.getElementById('filterDest').value;

      container.innerHTML = Components.loading();
      allResults = [];

      try {
        const ships = await API.getAllShips();
        const filteredShips = opFilter ? ships.filter(s => s.operator?.name?.includes(opFilter)) : ships;
        const threeMonths = new Date(Date.now() + 90 * 86400000);

        for (const ship of filteredShips) {
          const match = ship.href?.match(/ships\/([^.]+)\.json/);
          if (!match) continue;
          const shipData = await API.getShip(match[1]);
          if (!shipData?.cruises) continue;

          for (const c of shipData.cruises) {
            try {
              const h = await API.getHoliday(c.ref);
              if (!h?.date_from) continue;
              const depDate = new Date(h.date_from);
              if (depDate < threeMonths) continue;

              // Destination filter
              if (destFilter && !API.matchesDest(h, destFilter)) continue;

              // Month filter
              if (monthFilter) {
                const [y, m] = monthFilter.split('-');
                if (depDate.getFullYear() !== parseInt(y) || depDate.getMonth() + 1 !== parseInt(m)) continue;
              }

              // Duration filter
              const nights = h.cruise_nights || h.duration_days || 0;
              if (durFilter === 'short' && nights > 5) continue;
              if (durFilter === 'medium' && (nights < 6 || nights > 10)) continue;
              if (durFilter === 'long' && nights < 11) continue;

              allResults.push({ holiday: h, shipInfo: { coverImage: ship.cover_image_href, operator: ship.operator?.name } });
            } catch (e) { continue; }
          }
        }

        allResults.sort((a, b) => new Date(a.holiday.date_from) - new Date(b.holiday.date_from));
        currentPage = 1;
        renderPage();
      } catch (e) {
        console.error(e);
        container.innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
      }
    }

    function renderPage() {
      const container = document.getElementById('cruiseList');
      const pagination = document.getElementById('pagination');
      const countEl = document.getElementById('resultCount');

      countEl.textContent = `ì´ ${allResults.length}ê°œì˜ í¬ë£¨ì¦ˆ`;

      if (allResults.length === 0) {
        container.innerHTML = '<div class="empty-state"><span class="emoji">ğŸ”</span><p>ì¡°ê±´ì— ë§ëŠ” í¬ë£¨ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p></div>';
        pagination.innerHTML = '';
        return;
      }

      const totalPages = Math.ceil(allResults.length / PER_PAGE);
      const start = (currentPage - 1) * PER_PAGE;
      const pageItems = allResults.slice(start, start + PER_PAGE);

      container.innerHTML = pageItems.map(r => Components.cruiseItem(r.holiday, r.shipInfo)).join('');

      // Pagination
      if (totalPages > 1) {
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
          html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
        }
        pagination.innerHTML = html;
      } else {
        pagination.innerHTML = '';
      }
    }

    function goPage(p) {
      currentPage = p;
      renderPage();
      window.scrollTo({ top: 300, behavior: 'smooth' });
    }

    function applyFilters() {
      const d = document.getElementById('filterDest').value;
      const op = document.getElementById('filterOperator').value;
      const m = document.getElementById('filterMonth').value;
      const dur = document.getElementById('filterDuration').value;
      let url = 'destination.html?';
      if (d) url += `dest=${d}&`;
      if (op) url += `operator=${op}&`;
      if (m) url += `month=${m}&`;
      if (dur) url += `duration=${dur}&`;
      location.href = url.slice(0, -1);
    }

    loadCruises();
  </script>
</body>
</html>
